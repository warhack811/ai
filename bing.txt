from __future__ import annotations

from dataclasses import dataclass
from typing import List, Optional

import requests

from core.config import get_settings
from core.logger import get_logger

logger = get_logger(__name__)
settings = get_settings()


@dataclass
class BingResult:
    title: str
    url: str
    snippet: str


def bing_search(query: str, max_results: int = 5) -> List[BingResult]:
    """
    Bing Web Search API üzerinden arama yapar.
    BING_API_KEY yoksa veya hata olursa boş liste döner.
    """
    api_key = settings.BING_API_KEY
    endpoint = settings.BING_ENDPOINT

    if not api_key:
        logger.info("[BING] API key ayarlı değil, bu provider devre dışı.")
        return []

    headers = {
        "Ocp-Apim-Subscription-Key": api_key,
    }
    params = {
        "q": query,
        "mkt": "tr-TR",
        "count": max_results,
        "responseFilter": "Webpages",
    }

    try:
        resp = requests.get(endpoint, headers=headers, params=params, timeout=2.0)
        resp.raise_for_status()
        data = resp.json()

        web = data.get("webPages", {}).get("value", [])
        results: List[BingResult] = []
        for item in web:
            title = item.get("name") or ""
            url = item.get("url") or ""
            snippet = item.get("snippet") or item.get("description") or ""
            if not title and not snippet:
                continue
            results.append(BingResult(title=title, url=url, snippet=snippet))

        logger.info(f"[BING] '{query}' için {len(results)} sonuç döndü.")
        return results

    except Exception as e:
        logger.warning(f"[BING] Arama sırasında sorun: {e}")
        return []

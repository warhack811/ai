from __future__ import annotations

import json
import secrets
from dataclasses import dataclass, asdict
from datetime import datetime
from pathlib import Path
from typing import List, Optional

from core.logger import get_logger

logger = get_logger(__name__)

DATA_DIR = Path("data")
DATA_DIR.mkdir(exist_ok=True)
INVITES_FILE = DATA_DIR / "invites.json"


@dataclass
class InviteCode:
    code: str
    created_at: str
    created_by: str
    used: bool = False
    used_at: Optional[str] = None
    used_by: Optional[str] = None

    @staticmethod
    def from_dict(data: dict) -> "InviteCode":
        return InviteCode(
            code=data["code"],
            created_at=data.get("created_at", ""),
            created_by=data.get("created_by", "system"),
            used=data.get("used", False),
            used_at=data.get("used_at"),
            used_by=data.get("used_by"),
        )


def _load_invites() -> List[InviteCode]:
    if not INVITES_FILE.exists():
        logger.info("invites.json bulunamadı, boş liste ile başlıyoruz.")
        return []
    with INVITES_FILE.open("r", encoding="utf-8") as f:
        raw = json.load(f)
    return [InviteCode.from_dict(i) for i in raw]

def list_invites() -> List[InviteCode]:
    """
    Admin paneli için tüm davet kodlarını döner.
    """
    return _load_invites()

def _save_invites(invites: List[InviteCode]) -> None:
    with INVITES_FILE.open("w", encoding="utf-8") as f:
        json.dump([asdict(i) for i in invites], f, ensure_ascii=False, indent=2)
def list_invites() -> List[InviteCode]:
    """
    Admin paneli için tüm davet kodlarını döner.
    """
    return _load_invites()


def delete_invite(code: str) -> bool:
    """
    Verilen kodu siler. Bulamazsa False döner.
    """
    invites = _load_invites()
    new_invites = [i for i in invites if i.code.lower() != code.lower()]
    if len(new_invites) == len(invites):
        # hiç kimse silinmedi
        return False
    _save_invites(new_invites)
    return True


def generate_invite(created_by: str = "system") -> InviteCode:
    code = secrets.token_hex(5).upper()
    invite = InviteCode(
        code=code,
        created_at=datetime.utcnow().isoformat(),
        created_by=created_by,
    )
    invites = _load_invites()
    invites.append(invite)
    _save_invites(invites)
    logger.info(f"Yeni davet kodu oluşturuldu: {code}")
    return invite


def find_valid_invite(code: str) -> Optional[InviteCode]:
    invites = _load_invites()
    for inv in invites:
        if inv.code.lower() == code.lower() and not inv.used:
            return inv
    return None


def mark_invite_used(code: str, username: str) -> None:
    invites = _load_invites()
    now = datetime.utcnow().isoformat()
    for inv in invites:
        if inv.code.lower() == code.lower():
            inv.used = True
            inv.used_at = now
            inv.used_by = username
            break
    _save_invites(invites)


def ensure_initial_invite() -> InviteCode:
    invites = _load_invites()
    if invites:
        return invites[-1]
    invite = generate_invite("system")
    logger.info(f"İlk test davet kodu: {invite.code}")
    return invite

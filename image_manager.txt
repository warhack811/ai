from __future__ import annotations

from typing import Callable, Dict, Any

from image.job_queue import job_queue, ImageJob
from image.flux_stub import generate_image_via_forge
from image.gpu_state import switch_to_flux, switch_to_gemma
from core.logger import get_logger

logger = get_logger(__name__)

# ğŸ”¹ Basit image kuyruÄŸu istatistikleri
_image_stats: Dict[str, Any] = {
    "total_jobs": 0,        # bugÃ¼ne kadar kaÃ§ image iÅŸi alÄ±ndÄ±
    "pending_jobs": 0,      # ÅŸu an sÄ±rada kaÃ§ iÅŸ var (yaklaÅŸÄ±k)
    "last_username": None,  # son image isteyen kullanÄ±cÄ±
    "last_prompt": None,    # son image promptâ€™unun kÄ±saltÄ±lmÄ±ÅŸ hali
}


def _on_job_added(username: str, prompt: str) -> None:
    _image_stats["total_jobs"] += 1
    _image_stats["pending_jobs"] += 1
    _image_stats["last_username"] = username
    # Prompt Ã§ok uzun olmasÄ±n
    _image_stats["last_prompt"] = (prompt[:120] + "â€¦") if len(prompt) > 120 else prompt


def _on_job_finished() -> None:
    if _image_stats["pending_jobs"] > 0:
        _image_stats["pending_jobs"] -= 1


def get_image_queue_stats() -> Dict[str, Any]:
    """
    Admin paneli iÃ§in image kuyruÄŸu hakkÄ±nda basit istatistik dÃ¶ner.
    """
    return dict(_image_stats)


def request_image_generation(username: str, prompt: str, callback: Callable[[str], None]):
    """
    KullanÄ±cÄ±dan gelen resim isteÄŸini kuyruk sistemine gÃ¶nderir.
    Ä°statistikleri de gÃ¼nceller.
    """
    _on_job_added(username, prompt)

    # Job bittiÄŸinde hem istatistik gÃ¼ncellensin hem asÄ±l callback Ã§alÄ±ÅŸsÄ±n
    def wrapped_callback(result: str) -> None:
        _on_job_finished()
        try:
            callback(result)
        except Exception as e:
            logger.error(f"[IMAGE_MANAGER] Callback Ã§alÄ±ÅŸÄ±rken hata: {e}")

    job = ImageJob(username, prompt, on_done=wrapped_callback)
    job_queue.add_job(job)

    
def generate_image_sync(username: str, prompt: str) -> str:
    """
    Kuyruk istatistiklerini gÃ¼ncelleyerek Forge/Flux Ã¼zerinden senkron resim Ã¼retir.
    - KullanÄ±cÄ±dan gelen prompt'u alÄ±r
    - GPU state'i Flux'a Ã§evirir (simÃ¼lasyon)
    - Forge'a istek gÃ¶nderir
    - BittiÄŸinde tekrar Gemma'ya dÃ¶ner
    - Sohbette kullanÄ±lacak metni dÃ¶ndÃ¼rÃ¼r
    """
    _on_job_added(username, prompt)
    try:
        switch_to_flux()
        image_url = generate_image_via_forge(prompt)
        # Hata geldiyse direkt dÃ¶ndÃ¼r
        if image_url.startswith("(IMAGE ERROR)"):
            return f"[IMAGE] {image_url}"
        # BaÅŸarÄ±lÄ±ysa standardize cevap:
        return f"[IMAGE] Resminiz oluÅŸturuldu.\nIMAGE_PATH: {image_url}"
    except Exception as e:
        logger.error(f"[IMAGE_MANAGER] generate_image_sync hata: {e}")
        return f"[IMAGE] Resim Ã¼retilirken bir hata oluÅŸtu: {e}"
    finally:
        try:
            switch_to_gemma()
        finally:
            _on_job_finished()
